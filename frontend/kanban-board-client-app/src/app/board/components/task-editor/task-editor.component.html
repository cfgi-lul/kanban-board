<div class="edit-task-dialog">
  <div mat-dialog-title class="edit-task-dialog__title">
    {{ 'board.editTask' | translate }}
  </div>
  <mat-dialog-content [formGroup]="taskForm" class="edit-task-dialog__content">
    <mat-form-field appearance="fill" class="edit-task-dialog__field">
      <mat-label>{{ 'board.taskTitle' | translate }}</mat-label>
      <input matInput formControlName="title" required />
      @if (taskForm.get('title')?.value) {
        <button
          matSuffix
          mat-icon-button
          [attr.aria-label]="'common.clear' | translate"
          (click)="onClearTitle()"
        >
          <mat-icon>clear</mat-icon>
        </button>
      }
      @if (taskForm.get('title')?.hasError('required')) {
        <mat-error>{{ 'validation.required' | translate }}</mat-error>
      }
    </mat-form-field>

    <kn-task-description
      formControlName="description"
      [isEdit]="isEditDescription"
      (toggle)="toggleEditDescription()"
    />

    <mat-form-field appearance="fill" class="edit-task-dialog__field">
      <mat-label>{{ 'board.taskPriority' | translate }}</mat-label>
      <mat-select formControlName="priority">
        @for (option of priorityOptions; track option.value) {
          <mat-option [value]="option.value">{{ option.label }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill" class="edit-task-dialog__field">
      <mat-label>{{ 'board.taskDueDate' | translate }}</mat-label>
      <input
        matInput
        [matDatepicker]="dueDatePicker"
        formControlName="dueDate"
      />
      <mat-datepicker-toggle
        matSuffix
        [for]="dueDatePicker"
      ></mat-datepicker-toggle>
      <mat-datepicker #dueDatePicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="fill" class="edit-task-dialog__field">
      <mat-label>{{ 'board.taskAssignee' | translate }}</mat-label>
      <mat-select formControlName="assignee">
        <mat-option [value]="null">{{ 'common.none' | translate }}</mat-option>
        @for (user of users$ | async; track user.id) {
          <mat-option [value]="user.id">{{
            user.displayName || user.username
          }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    @if (data.task.createdBy) {
      <div class="edit-task-dialog__info-field">
        <span class="edit-task-dialog__info-label"
          >{{ 'board.createdBy' | translate }}:</span
        >
        <span class="edit-task-dialog__info-value">{{
          data.task.createdBy.displayName || data.task.createdBy.username
        }}</span>
      </div>
    }

    @if (data.task.createdAt) {
      <div class="edit-task-dialog__info-field">
        <span class="edit-task-dialog__info-label"
          >{{ 'board.createdAt' | translate }}:</span
        >
        <span class="edit-task-dialog__info-value">{{
          data.task.createdAt | date: 'medium'
        }}</span>
      </div>
    }

    @if (data.task.updatedAt) {
      <div class="edit-task-dialog__info-field">
        <span class="edit-task-dialog__info-label"
          >{{ 'board.updatedAt' | translate }}:</span
        >
        <span class="edit-task-dialog__info-value">{{
          data.task.updatedAt | date: 'medium'
        }}</span>
      </div>
    }

    <mat-form-field appearance="fill" class="edit-task-dialog__field">
      <mat-label>{{ 'board.labels' | translate }}</mat-label>
      <mat-chip-grid #chipGrid>
        @for (label of taskForm.get('labels')?.value; track label.id) {
          <mat-chip-row (removed)="removeLabel(label)">
            <div
              class="edit-task-dialog__label-chip"
              [style.background-color]="label.color"
            >
              {{ label.name }}
            </div>
            <button matChipRemove>
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip-row>
        }
        <input
          placeholder="{{ 'board.addLabel' | translate }}..."
          [matChipInputFor]="chipGrid"
          [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
          (matChipInputTokenEnd)="addLabel($event)"
        />
      </mat-chip-grid>
      <mat-autocomplete #auto="matAutocomplete">
        @for (label of filteredLabels; track label.id) {
          <mat-option [value]="label.name">
            <div
              class="edit-task-dialog__label-option"
              [style.background-color]="label.color"
            >
              {{ label.name }}
            </div>
          </mat-option>
        }
      </mat-autocomplete>
    </mat-form-field>

    <kn-attachment-picker [taskId]="data.task.id" />

    <kn-task-comments [taskId]="data.task.id" />

  </mat-dialog-content>
  <mat-dialog-actions align="end" class="edit-task-dialog__actions">
    <button
      mat-button
      (click)="onCancel()"
      class="edit-task-dialog__actions__button edit-task-dialog__actions__button--cancel"
    >
      {{ 'common.cancel' | translate }}
    </button>
    <button
      mat-button
      (click)="onSave()"
      [disabled]="taskForm.invalid"
      class="edit-task-dialog__actions__button edit-task-dialog__actions__button--save"
    >
      {{ 'common.save' | translate }}
    </button>
  </mat-dialog-actions>
</div>
